# RBAC管理员服务器 - 项目部署文档

## 📝 项目概况

RBAC管理员服务器是一个基于Go语言开发的权限管理系统，实现了完整的RBAC（基于角色的访问控制）功能。该系统支持多环境配置管理、灵活的数据库选择、高性能缓存以及安全的认证授权机制，适用于各类企业级应用的权限管理需求。

### ✨ 主要功能特点

- **完整的RBAC权限控制**：用户、角色、权限三级管理体系
- **多数据库支持**：兼容MySQL、PostgreSQL和SQLite
- **高性能缓存**：集成Redis实现数据缓存
- **灵活的配置管理**：支持多环境配置、环境变量覆盖
- **安全认证**：基于JWT的身份认证机制
- **跨域支持**：完善的CORS配置
- **日志系统**：多级别、多格式的日志记录
- **API文档**：集成Swagger文档

## 🛠️ 项目技术栈

| 技术/框架       | 版本/说明                       | 用途                           |
|---------------|-------------------------------|--------------------------------|
| Go            | 1.24.0+                       | 主要开发语言                    |
| GORM          | 最新版                         | ORM框架，数据库操作             |
| MySQL         | 5.7+/8.0+                     | 关系型数据库（生产环境）         |
| PostgreSQL    | 9.6+/10+                      | 可选关系型数据库                 |
| SQLite        | 内置                           | 轻量级数据库（开发环境）         |
| Redis         | 5.0+                          | 缓存数据库                      |
| Gin           | 最新版                         | Web框架                        |
| JWT           | 最新版                         | 身份认证                        |
| Logrus        | 最新版                         | 结构化日志                      |
| Swagger       | 最新版                         | API文档                        |

## 🚀 项目部署步骤

### 🏗️ 环境准备

1. **安装Go环境**
   ```bash
   # 下载并安装Go 1.24.0或更高版本
   # 验证安装
   go version
   ```

2. **安装依赖服务**
   - **生产环境**：MySQL 5.7+ 和 Redis 5.0+
   - **开发环境**：推荐安装MySQL和Redis，也可直接使用SQLite

### 📥 获取项目代码

```bash
# 克隆代码库
git clone <your-repo-url>
cd rbac_admin_server

# 安装依赖
go mod download
```

### ⚙️ 配置环境变量

```bash
# 复制环境变量模板
cp .env.example .env

# 编辑.env文件，配置必要的环境变量
# 至少需要配置以下关键项：
# - DB_PASSWORD
# - JWT_SECRET
# - CSRF_SECRET
```

### 🔧 数据库准备

```bash
# 1. 创建MySQL数据库
sudo mysql -u root -p
CREATE DATABASE rbacadmin DEFAULT CHARACTER SET utf8mb4 COLLATE utf8mb4_general_ci;
EXIT;

# 2. 确保Redis服务正在运行
systemctl status redis
```

### 🏃‍♂️ 启动项目

#### 开发环境

```bash
# 使用开发环境配置（SQLite数据库）
go run main.go -env dev
```

#### 测试环境

```bash
# 使用测试环境配置
go run main.go -env test
```

#### 生产环境

```bash
# 1. 构建二进制文件
GOOS=linux GOARCH=amd64 go build -o rbac_admin_server main.go

# 2. 运行服务
./rbac_admin_server -env prod
```

### 📦 使用部署脚本

#### Windows环境

```batch
# 运行Windows部署脚本
.\deploy.bat
```

#### Linux/Mac环境

```bash
# 赋予执行权限
chmod +x deploy.sh

# 运行部署脚本
./deploy.sh
```

## 📁 项目目录结构和组件

### 📊 目录结构概览

```
rbac_admin_server/
├── api/               # API控制器层
├── config/            # 配置相关代码
├── core/              # 核心组件初始化
├── global/            # 全局变量
├── middleware/        # 中间件
├── models/            # 数据模型
├── routes/            # 路由定义
├── service/           # 业务逻辑层
├── utils/             # 工具函数
├── .env               # 环境变量文件
├── .env.example       # 环境变量示例
├── deploy.bat         # Windows部署脚本
├── deploy.sh          # Linux/Mac部署脚本
├── main.go            # 程序入口
├── settings.yaml      # 主配置文件
├── settings_dev.yaml  # 开发环境配置
├── settings_prod.yaml # 生产环境配置
└── settings_test.yaml # 测试环境配置
```

### 🔍 核心组件说明

| 组件         | 主要职责                       | 文件位置                  | <mcfile>引用                                |
|-------------|-------------------------------|--------------------------|--------------------------------------------|
| 程序入口      | 程序初始化、启动和信号处理       | main.go                  | <mcfile name="main.go" path="e:\myblog\Go项目学习\rbac_admin_server\main.go"></mcfile> |
| 系统初始化    | 按顺序初始化各核心组件           | core/init.go             | <mcfile name="init.go" path="e:\myblog\Go项目学习\rbac_admin_server\core\init.go"></mcfile> |
| 数据库连接    | 初始化GORM和数据库连接          | core/db.go               | <mcfile name="db.go" path="e:\myblog\Go项目学习\rbac_admin_server\core\db.go"></mcfile> |
| Redis连接    | 初始化Redis客户端               | core/redis.go            | <mcfile name="redis.go" path="e:\myblog\Go项目学习\rbac_admin_server\core\redis.go"></mcfile> |
| 配置定义      | 定义配置结构体和默认值           | config/config.go         | <mcfile name="config.go" path="e:\myblog\Go项目学习\rbac_admin_server\config\config.go"></mcfile> |

## 🔄 项目代码配置和运行加载流程

### 📋 配置加载流程

1. **命令行参数解析**
   - 解析`-env`参数确定运行环境（dev/test/prod）
   - 解析`-config`参数确定配置文件路径

2. **配置文件加载**
   - 优先级：命令行指定配置文件 > 环境特定配置文件 > 主配置文件
   - 支持的配置文件：`settings.yaml`、`settings_dev.yaml`、`settings_test.yaml`、`settings_prod.yaml`

3. **环境变量覆盖**
   - 从`.env`文件加载环境变量
   - 环境变量会覆盖配置文件中的同名配置项

4. **全局配置设置**
   - 加载完成的配置会设置到`global.Config`全局变量中供系统使用

### 🏃 系统启动流程

1. **程序入口** (`main.go`)
   - 解析命令行参数
   - 加载配置文件
   - 设置全局配置
   - 调用系统初始化

2. **系统初始化** (`core/init.go`)
   ```go
   // 初始化顺序
   1. 初始化日志系统
   2. 初始化验证器
   3. 初始化数据库连接
   4. 初始化Redis连接
   5. 自动迁移数据库表结构
   ```

3. **数据库初始化** (`core/db.go`)
   - 根据配置选择数据库类型（MySQL/PostgreSQL/SQLite）
   - 构建数据库连接字符串
   - 配置连接池参数
   - 测试数据库连接

4. **Redis初始化** (`core/redis.go`)
   - 创建Redis客户端
   - 配置连接池和超时参数
   - 测试Redis连接

5. **数据库迁移**
   - 自动创建或更新数据库表结构
   - 支持所有模型的迁移

6. **等待退出信号**
   - 监听系统信号（如SIGINT、SIGTERM）
   - 接收到信号时执行资源清理

## 🚢 项目部署模式介绍

### 🌱 开发环境部署

**特点**：
- 使用SQLite内存数据库，无需额外配置
- 详细的日志输出，便于调试
- 自动热重载支持（可通过第三方工具实现）
- 开放更多调试接口

**启动命令**：
```bash
go run main.go -env dev
```

### 🧪 测试环境部署

**特点**：
- 使用独立的测试数据库
- 配置更接近生产环境
- 适合自动化测试和集成测试

**启动命令**：
```bash
go run main.go -env test
```

### 🚀 生产环境部署

**特点**：
- 使用高性能MySQL数据库
- 集成Redis缓存
- 最小化日志输出，只记录关键信息
- 禁用调试接口和功能
- 使用环境变量保护敏感信息

**部署建议**：

1. **二进制部署**
   ```bash
   # 编译二进制文件
   GOOS=linux GOARCH=amd64 go build -o rbac_admin_server main.go
   
   # 部署到服务器
   scp rbac_admin_server user@server:/path/to/deploy
   scp .env user@server:/path/to/deploy
   scp settings_prod.yaml user@server:/path/to/deploy
   
   # 在服务器上运行
   cd /path/to/deploy
   ./rbac_admin_server -env prod
   ```

2. **使用Systemd管理服务**
   ```bash
   # 创建systemd服务文件
   sudo vim /etc/systemd/system/rbac_admin.service
   
   # 服务文件内容
   [Unit]
   Description=RBAC Admin Server
   After=network.target mysql.service redis.service
   
   [Service]
   Type=simple
   User=www-data
   WorkingDirectory=/path/to/deploy
   ExecStart=/path/to/deploy/rbac_admin_server -env prod
   Restart=on-failure
   
   [Install]
   WantedBy=multi-user.target
   
   # 启用并启动服务
   sudo systemctl daemon-reload
   sudo systemctl enable rbac_admin
   sudo systemctl start rbac_admin
   ```

3. **Docker容器化部署**（扩展建议）
   ```yaml
   # docker-compose.yml示例
   version: '3'
   
   services:
     app:
       build: .
       ports:
         - "8080:8080"
       depends_on:
         - mysql
         - redis
       env_file:
         - .env
       restart: always
       
     mysql:
       image: mysql:8.0
       environment:
         MYSQL_ROOT_PASSWORD: your_password
         MYSQL_DATABASE: rbacadmin
       volumes:
         - mysql-data:/var/lib/mysql
       restart: always
       
     redis:
       image: redis:6.0
       volumes:
         - redis-data:/data
       restart: always
   
   volumes:
     mysql-data:
     redis-data:
   ```

## 📚 附录

### 🔧 常用命令

```bash
# 查看应用日志
tail -f ./logs/app.log

# 数据库迁移（如需手动执行）
go run main.go -env prod -migrate

# 检查服务状态
systemctl status rbac_admin

# 重启服务
systemctl restart rbac_admin
```

### ⚠️ 注意事项

1. **安全配置**
   - 生产环境务必使用强密码和密钥
   - 不要将敏感信息硬编码到配置文件中
   - 定期更新JWT密钥和CSRF密钥

2. **性能优化**
   - 根据实际负载调整数据库连接池参数
   - 合理设置Redis缓存策略
   - 监控系统资源使用情况

3. **备份策略**
   - 定期备份数据库
   - 备份关键配置文件
   - 考虑实现日志轮转和归档

4. **监控与告警**
   - 建议集成Prometheus和Grafana进行监控
   - 设置关键指标告警（如响应时间、错误率等）

---

📅 更新时间：2024年7月
👨‍💻 维护者：RBAC Admin Team