# RBACç®¡ç†å‘˜æœåŠ¡å™¨é…ç½®æµç¨‹å…³ç³»æ–‡æ¡£

## ğŸ¯ é¡¹ç›®æ¦‚è¿°

è¿™æ˜¯ä¸€ä¸ªåŸºäºGinæ¡†æ¶çš„RBACç®¡ç†å‘˜æœåŠ¡å™¨é¡¹ç›®ï¼Œé‡‡ç”¨åˆ†å±‚æ¶æ„è®¾è®¡ï¼Œæ”¯æŒé…ç½®æ–‡ä»¶çš„çƒ­é‡è½½å’Œå›å†™åŠŸèƒ½ã€‚

## ğŸ“ é¡¹ç›®ç»“æ„

```
rbac_admin_server/
â”œâ”€â”€ config/                    # é…ç½®å®šä¹‰å±‚
â”‚   â”œâ”€â”€ enter.go              # é…ç½®å…¥å£ç»“æ„ä½“
â”‚   â””â”€â”€ system.go             # ç³»ç»Ÿé…ç½®å®šä¹‰
â”œâ”€â”€ core/                     # é…ç½®æ“ä½œæ ¸å¿ƒå±‚
â”‚   â”œâ”€â”€ read_config.go        # é…ç½®è¯»å–åŠŸèƒ½
â”‚   â””â”€â”€ set_config.go         # é…ç½®å†™å…¥åŠŸèƒ½
â”œâ”€â”€ global/                   # å…¨å±€å˜é‡å±‚
â”‚   â””â”€â”€ global.go             # å…¨å±€é…ç½®å®ä¾‹
â”œâ”€â”€ config_manager.go         # é«˜çº§é…ç½®ç®¡ç†å™¨ï¼ˆçƒ­é‡è½½+å›å†™ï¼‰
â”œâ”€â”€ main.go                   # ä¸»ç¨‹åºå…¥å£
â”œâ”€â”€ settings.yaml             # å®é™…é…ç½®æ–‡ä»¶
â””â”€â”€ é…ç½®æµç¨‹å…³ç³».md           # æœ¬æ–‡æ¡£
```

## ğŸ”— é…ç½®è°ƒç”¨å…³ç³»å›¾

```mermaid
graph TD
    A[main.go] --> B[config_manager.go]
    A --> C[global/global.go]
    B --> D[settings.yaml]
    C --> E[config/]
    
    subgraph "æ—§é…ç½®ç³»ç»Ÿ"
        F[core/read_config.go] --> G[config/]
        H[core/set_config.go] --> I[.setting.yaml]
        G --> C
    end
    
    subgraph "æ–°é…ç½®ç³»ç»Ÿ"
        B --> D
        D --> B
    end
```

## ğŸ—ï¸ é…ç½®å±‚çº§æ¶æ„

### ç¬¬ä¸€å±‚ï¼šé…ç½®å®šä¹‰å±‚ (config/)
- **ä½œç”¨**ï¼šå®šä¹‰æ‰€æœ‰é…ç½®ç»“æ„ä½“
- **æ–‡ä»¶**ï¼š
  - `enter.go`ï¼šé…ç½®æ€»å…¥å£ç»“æ„ä½“
  - `system.go`ï¼šç³»ç»Ÿçº§é…ç½®ç»†åˆ†

### ç¬¬äºŒå±‚ï¼šå…¨å±€ç®¡ç†å±‚ (global/)
- **ä½œç”¨**ï¼šæä¾›å…¨å±€é…ç½®å®ä¾‹è®¿é—®
- **æ–‡ä»¶**ï¼š
  - `global.go`ï¼šå…¨å±€Configå˜é‡å®šä¹‰

### ç¬¬ä¸‰å±‚ï¼šé…ç½®æ“ä½œå±‚ (core/)
- **ä½œç”¨**ï¼šæä¾›é…ç½®çš„è¯»å†™æ“ä½œï¼ˆæ—§ç³»ç»Ÿï¼‰
- **æ–‡ä»¶**ï¼š
  - `read_config.go`ï¼šä»settings.yamlè¯»å–é…ç½®
  - `set_config.go`ï¼šå†™å…¥é…ç½®åˆ°.setting.yaml

### ç¬¬å››å±‚ï¼šé«˜çº§ç®¡ç†å±‚ (config_manager.go)
- **ä½œç”¨**ï¼šæä¾›ç°ä»£åŒ–çš„é…ç½®ç®¡ç†åŠŸèƒ½
- **ç‰¹æ€§**ï¼š
  - é…ç½®çƒ­é‡è½½ï¼ˆåŸºäºfsnotifyï¼‰
  - é…ç½®å›å†™ï¼ˆåŸå­å†™å…¥ï¼‰
  - çº¿ç¨‹å®‰å…¨è®¿é—®
  - å®æ—¶æ–‡ä»¶ç›‘æ§

### ç¬¬äº”å±‚ï¼šåº”ç”¨å…¥å£å±‚ (main.go)
- **ä½œç”¨**ï¼šæ•´åˆæ‰€æœ‰é…ç½®ç³»ç»Ÿï¼Œæä¾›æ¼”ç¤ºåŠŸèƒ½

## ğŸ”„ é…ç½®æµç¨‹è¯¦è§£

### åˆå§‹åŒ–æµç¨‹

```go
// 1. main.go ä¸­çš„åˆå§‹åŒ–æµç¨‹
func main() {
    // æ­¥éª¤1: åˆ›å»ºé…ç½®ç®¡ç†å™¨
    configManager, err := NewConfigManager("./settings.yaml")
    
    // æ­¥éª¤2: è·å–å½“å‰é…ç½®
    config := configManager.GetConfig()
    
    // æ­¥éª¤3: ä½¿ç”¨é…ç½®
    fmt.Printf("ç«¯å£: %d", config.Server.Port)
}
```

### è¯»å–é…ç½®æµç¨‹

#### æ—§ç³»ç»Ÿæµç¨‹ï¼ˆå·²åºŸå¼ƒï¼‰
```go
// core/read_config.go
func ReadConfig() *config.Config {
    // 1. è¯»å–settings.yamlæ–‡ä»¶
    byteData, _ := os.ReadFile("./settings.yaml")
    
    // 2. è§£æYAMLåˆ°ç»“æ„ä½“
    var c *config.Config
    yaml.Unmarshal(byteData, &c)
    
    // 3. è¿”å›é…ç½®å®ä¾‹
    return c
}
```

#### æ–°ç³»ç»Ÿæµç¨‹ï¼ˆæ¨èï¼‰
```go
// config_manager.go
func (cm *ConfigManager) load() error {
    // 1. è¯»å–æ–‡ä»¶
    data, _ := os.ReadFile(cm.filename)
    
    // 2. è§£æYAML
    var newConfig Config
    yaml.Unmarshal(data, &newConfig)
    
    // 3. çº¿ç¨‹å®‰å…¨æ›´æ–°
    cm.mu.Lock()
    cm.config = &newConfig
    cm.mu.Unlock()
    
    return nil
}
```

### å†™å…¥é…ç½®æµç¨‹

#### æ—§ç³»ç»Ÿæµç¨‹ï¼ˆå·²åºŸå¼ƒï¼‰
```go
// core/set_config.go
func SetConfig(c *config.Config) {
    // 1. åºåˆ—åŒ–é…ç½®
    byteData, _ := yaml.Marshal(c)
    
    // 2. å†™å…¥.setting.yaml
    os.WriteFile(".setting.yaml", byteData, 0666)
}
```

#### æ–°ç³»ç»Ÿæµç¨‹ï¼ˆæ¨èï¼‰
```go
// config_manager.go
func (cm *ConfigManager) SaveConfig(newConfig *Config) error {
    // 1. åºåˆ—åŒ–é…ç½®
    data, _ := yaml.Marshal(newConfig)
    
    // 2. åŸå­å†™å…¥ï¼ˆä¸´æ—¶æ–‡ä»¶+é‡å‘½åï¼‰
    tempFile := cm.filename + ".tmp"
    os.WriteFile(tempFile, data, 0644)
    os.Rename(tempFile, cm.filename)
    
    // 3. æ›´æ–°å†…å­˜é…ç½®
    cm.config = newConfig
    
    return nil
}
```

### çƒ­é‡è½½æµç¨‹

```go
// config_manager.go
func (cm *ConfigManager) setupWatcher() error {
    // 1. åˆ›å»ºæ–‡ä»¶ç›‘å¬å™¨
    watcher, _ := fsnotify.NewWatcher()
    
    // 2. ç›‘å¬æ–‡ä»¶å˜åŒ–
    go func() {
        for {
            select {
            case event := <-watcher.Events:
                if event.Op&fsnotify.Write == fsnotify.Write {
                    // 3. å»¶è¿Ÿ100msé¿å…å†™å…¥å†²çª
                    time.Sleep(100 * time.Millisecond)
                    
                    // 4. é‡æ–°åŠ è½½é…ç½®
                    cm.load()
                }
            }
        }
    }()
    
    // 5. æ·»åŠ ç›‘å¬æ–‡ä»¶
    watcher.Add(cm.filename)
    
    return nil
}
```

## ğŸ“Š é…ç½®ç»“æ„å¯¹æ¯”

### æ—§é…ç½®ç»“æ„ (config/)
```go
// config/enter.go
package config

type Config struct {
    System SystemConfig `yaml:"system"`
}

// config/system.go
package config

type SystemConfig struct {
    Port int `yaml:"port"`
}
```

### æ–°é…ç½®ç»“æ„ (main.go)
```go
type Config struct {
    Server struct {
        Port int    `yaml:"port"`
        Mode string `yaml:"mode"`
    } `yaml:"server"`
    
    Database struct {
        Driver       string `yaml:"driver"`
        Host         string `yaml:"host"`
        Port         int    `yaml:"port"`
        Username     string `yaml:"username"`
        Password     string `yaml:"password"`
        Database     string `yaml:"database"`
        Charset      string `yaml:"charset"`
        MaxOpenConns int    `yaml:"max_open_conns"`
        MaxIdleConns int    `yaml:"max_idle_conns"`
    } `yaml:"database"`
    
    // ... å…¶ä»–é…ç½®
}
```

## ğŸ”„ æ•´åˆå»ºè®®

### æ–¹æ¡ˆä¸€ï¼šå®Œå…¨è¿ç§»åˆ°æ–°ç³»ç»Ÿ
1. **åˆ é™¤æ—§ç³»ç»Ÿæ–‡ä»¶**:
   - `core/read_config.go`
   - `core/set_config.go`
   - `config/` ç›®å½•ä¸‹çš„æ–‡ä»¶

2. **ç»Ÿä¸€é…ç½®ç»“æ„**:
   - ä½¿ç”¨main.goä¸­çš„å®Œæ•´Configç»“æ„
   - æ›´æ–°settings.yamlæ ¼å¼åŒ¹é…æ–°ç»“æ„

3. **ä½¿ç”¨config_manager.go**:
   - ä½œä¸ºå”¯ä¸€çš„é…ç½®ç®¡ç†å…¥å£
   - æä¾›å®Œæ•´çš„é…ç½®ç®¡ç†åŠŸèƒ½

### æ–¹æ¡ˆäºŒï¼šå…¼å®¹æ€§æ”¹é€ 
1. **ä¿ç•™æ—§æ¥å£**:
   - ä¿®æ”¹core/read_config.goè°ƒç”¨config_manager.go
   - ä¿®æ”¹core/set_config.goè°ƒç”¨config_manager.go

2. **é€‚é…å±‚å®ç°**:
   ```go
   // core/read_config.go é€‚é…
   func ReadConfig() *Config {
       configManager, _ := NewConfigManager("./settings.yaml")
       return configManager.GetConfig()
   }
   
   // core/set_config.go é€‚é…
   func SetConfig(c *Config) error {
       configManager, _ := NewConfigManager("./settings.yaml")
       return configManager.SaveConfig(c)
   }
   ```

## ğŸ¯ æ¨èé…ç½®æµç¨‹

### æœ€ç»ˆæ¨èæ–¹æ¡ˆï¼šä½¿ç”¨æ–°ç³»ç»Ÿ

```go
// 1. ç»Ÿä¸€é…ç½®å®šä¹‰ï¼ˆå»ºè®®æ”¾åœ¨config/config.goï¼‰
package config

type Config struct {
    Server   ServerConfig   `yaml:"server"`
    Database DatabaseConfig `yaml:"database"`
    JWT      JWTConfig      `yaml:"jwt"`
    Redis    RedisConfig    `yaml:"redis"`
    Log      LogConfig      `yaml:"log"`
    Security SecurityConfig `yaml:"security"`
}

// 2. å…¨å±€è®¿é—®ï¼ˆglobal/global.goï¼‰
package global

import "rbac.admin/config"

var Config *config.Config

// 3. ä¸»ç¨‹åºä½¿ç”¨ï¼ˆmain.goï¼‰
func main() {
    configManager, _ := NewConfigManager("./settings.yaml")
    global.Config = configManager.GetConfig()
    
    // ä½¿ç”¨é…ç½®
    fmt.Println(global.Config.Server.Port)
}
```

## ğŸ“‹ é…ç½®æ–‡ä»¶æ ¼å¼æ ‡å‡†

### settings.yaml æ ‡å‡†æ ¼å¼
```yaml
server:
    port: 8080
    mode: debug

database:
    driver: mysql
    host: localhost
    port: 3306
    username: root
    password: password
    database: rbac_admin
    charset: utf8mb4
    max_open_conns: 100
    max_idle_conns: 10

jwt:
    secret: your-secret-key-here
    expire_hours: 24

redis:
    host: localhost
    port: 6379
    password: ""
    db: 0

log:
    level: info
    format: json
    output: stdout

security:
    bcrypt_cost: 10
    max_login_attempts: 5
    lock_duration_minutes: 30
```

## ğŸš€ ä¸‹ä¸€æ­¥è¡ŒåŠ¨è®¡åˆ’ï¼ˆå·²å®Œæˆâœ…ï¼‰

### 1. ç»Ÿä¸€é…ç½®ç³»ç»Ÿ âœ…
- [x] åˆ é™¤æ—§é…ç½®ç³»ç»Ÿæ–‡ä»¶
- [x] ç»Ÿä¸€ä½¿ç”¨config_manager.goä½œä¸ºå”¯ä¸€é…ç½®ç®¡ç†å™¨
- [x] æ›´æ–°main.goä½¿ç”¨æ–°çš„é…ç½®ç³»ç»Ÿ
- [x] ç¡®ä¿æ‰€æœ‰åŒ…éƒ½é€šè¿‡global.Configè®¿é—®é…ç½®

### 2. å®Œå–„é…ç½®ç»“æ„ âœ…
- [x] åˆ›å»ºconfig/config.goå®šä¹‰æ ‡å‡†é…ç½®ç»“æ„
- [x] æ·»åŠ é…ç½®éªŒè¯åŠŸèƒ½ï¼ˆåœ¨config/loader.goä¸­ï¼‰
- [x] æ·»åŠ é»˜è®¤å€¼å¤„ç†ï¼ˆåœ¨config/config.goä¸­ï¼‰
- [x] å®Œå–„æ³¨é‡Šæ–‡æ¡£

### 3. é›†æˆæµ‹è¯• âœ…
- [x] æµ‹è¯•é…ç½®åŠ è½½åŠŸèƒ½
- [x] æµ‹è¯•é…ç½®çƒ­é‡è½½
- [x] æµ‹è¯•é…ç½®å›å†™
- [x] éªŒè¯é…ç½®æ›´æ–°åŠŸèƒ½

## å®Œæ•´çš„é¡¹ç›®é…ç½®æµç¨‹

### å¯åŠ¨æµç¨‹
1. **main.go** å¯åŠ¨
   - è°ƒç”¨ `NewConfigManager("./settings.yaml")` åˆ›å»ºé…ç½®ç®¡ç†å™¨
   - è®¾ç½® `global.ConfigManager` å’Œ `global.Config`
   - å¯åŠ¨é…ç½®æ¼”ç¤ºå’Œä¼˜é›…å…³é—­å¤„ç†

2. **ConfigManager** åˆå§‹åŒ–
   - åŠ è½½settings.yamlæ–‡ä»¶
   - è®¾ç½®æ–‡ä»¶ç›‘æ§ï¼ˆfsnotifyï¼‰
   - å»ºç«‹é…ç½®ç¼“å­˜

### é…ç½®æ›´æ–°æµç¨‹
1. **æ‰‹åŠ¨æ›´æ–°**
   - è°ƒç”¨ `SaveConfig()` ç›´æ¥ä¿å­˜æ–°é…ç½®
   - è‡ªåŠ¨è§¦å‘æ–‡ä»¶ç›‘æ§é‡è½½

2. **çƒ­é‡è½½æ›´æ–°**
   - ä¿®æ”¹settings.yamlæ–‡ä»¶
   - fsnotifyæ£€æµ‹åˆ°æ–‡ä»¶å˜åŒ–
   - è‡ªåŠ¨é‡æ–°åŠ è½½é…ç½®
   - æ›´æ–°å…¨å±€é…ç½®å¼•ç”¨

3. **ç¨‹åºæ›´æ–°**
   - è°ƒç”¨ `UpdateConfig()` é€šè¿‡å›è°ƒå‡½æ•°æ›´æ–°é…ç½®
   - è‡ªåŠ¨ä¿å­˜å¹¶åŒæ­¥åˆ°æ–‡ä»¶

### é…ç½®éªŒè¯æµç¨‹
1. **å¯åŠ¨æ—¶éªŒè¯**
   - éªŒè¯ç«¯å£èŒƒå›´ã€æ•°æ®åº“è¿æ¥ã€JWTå¯†é’¥ç­‰
   - æä¾›è¯¦ç»†çš„é”™è¯¯ä¿¡æ¯

2. **è¿è¡Œæ—¶éªŒè¯**
   - æ¯æ¬¡é…ç½®æ›´æ–°éƒ½è¿›è¡ŒéªŒè¯
   - ç¡®ä¿é…ç½®æœ‰æ•ˆæ€§

## ä»£ç è°ƒç”¨å…³ç³»è¯¦è§£

### æ ¸å¿ƒç»„ä»¶
- **config/config.go**: é…ç½®ç»“æ„å®šä¹‰ï¼ˆâœ…å·²å®Œæˆï¼‰
- **config/loader.go**: é…ç½®åŠ è½½å’ŒéªŒè¯ï¼ˆâœ…å·²å®Œæˆï¼‰
- **config_manager.go**: é«˜çº§é…ç½®ç®¡ç†å™¨ï¼ˆâœ…å·²å®Œæˆï¼‰
- **global/global.go**: å…¨å±€é…ç½®è®¿é—®ï¼ˆâœ…å·²å®Œæˆï¼‰
- **main.go**: ç¨‹åºå…¥å£å’Œæ¼”ç¤ºï¼ˆâœ…å·²å®Œæˆï¼‰

### ä½¿ç”¨ç¤ºä¾‹
```go
// è·å–é…ç½®
port := global.Config.Server.Port

// æ›´æ–°é…ç½®
global.ConfigManager.UpdateConfig(func(c *config.Config) {
    c.Server.Port = 8080
})

// ä¿å­˜é…ç½®
global.ConfigManager.SaveConfig(global.Config)
```

## é¡¹ç›®çŠ¶æ€æ€»ç»“ âœ…

é¡¹ç›®é…ç½®ç³»ç»Ÿå·²å®Œå…¨ä¿®å¤å’Œç»Ÿä¸€ï¼š
1. âœ… åˆ é™¤äº†æ—§çš„é…ç½®ç³»ç»Ÿæ–‡ä»¶
2. âœ… åˆ›å»ºäº†ç»Ÿä¸€çš„é…ç½®ç»“æ„å®šä¹‰
3. âœ… å®ç°äº†é«˜çº§é…ç½®ç®¡ç†å™¨ï¼ˆæ”¯æŒçƒ­é‡è½½ï¼‰
4. âœ… æ·»åŠ äº†é…ç½®éªŒè¯å’Œé»˜è®¤å€¼å¤„ç†
5. âœ… å®Œå–„äº†å…¨å±€é…ç½®è®¿é—®æ¥å£
6. âœ… æä¾›äº†å®Œæ•´çš„é…ç½®ä½¿ç”¨ç¤ºä¾‹
7. âœ… æ‰€æœ‰ç»„ä»¶éƒ½æœ‰è¯¦ç»†çš„ä¸­æ–‡æ³¨é‡Š

ç°åœ¨é¡¹ç›®å…·å¤‡ç°ä»£åŒ–çš„é…ç½®ç®¡ç†èƒ½åŠ›ï¼Œæ”¯æŒï¼š
- é…ç½®çƒ­é‡è½½ï¼ˆæ— éœ€é‡å¯æœåŠ¡ï¼‰
- é…ç½®éªŒè¯ï¼ˆç¡®ä¿é…ç½®æœ‰æ•ˆæ€§ï¼‰
- é…ç½®å›å†™ï¼ˆç¨‹åºä¿®æ”¹é…ç½®è‡ªåŠ¨ä¿å­˜ï¼‰
- å…¨å±€è®¿é—®ï¼ˆæ‰€æœ‰åŒ…éƒ½èƒ½è®¿é—®é…ç½®ï¼‰
- è¯¦ç»†æ—¥å¿—ï¼ˆé…ç½®å˜æ›´éƒ½æœ‰æ—¥å¿—è®°å½•ï¼‰