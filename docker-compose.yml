# =================================================================================
# ğŸ³ Docker Compose é…ç½®æ–‡ä»¶
# =================================================================================
# ğŸ“‹ æ–‡ä»¶è¯´æ˜ï¼š
#   è¿™æ˜¯Docker Composeé…ç½®æ–‡ä»¶ï¼Œç”¨äºä¸€é”®éƒ¨ç½²å®Œæ•´çš„RBACç®¡ç†å‘˜æœåŠ¡å™¨ç¯å¢ƒ
#   åŒ…å«MySQLã€PostgreSQLã€Rediså’ŒRBACæœåŠ¡å™¨å››ä¸ªæœåŠ¡
#
# ğŸ¯ ä½¿ç”¨åœºæ™¯ï¼š
#   - æœ¬åœ°å¼€å‘ç¯å¢ƒå¿«é€Ÿæ­å»º
#   - æµ‹è¯•ç¯å¢ƒéƒ¨ç½²
#   - ç”Ÿäº§ç¯å¢ƒå®¹å™¨åŒ–éƒ¨ç½²
#
# ğŸš€ å¿«é€Ÿå¼€å§‹ï¼š
#   1. ç¡®ä¿å·²å®‰è£…Dockerå’ŒDocker Compose
#   2. åœ¨é¡¹ç›®æ ¹ç›®å½•æ‰§è¡Œï¼šdocker-compose up -d
#   3. è®¿é—®ï¼šhttp://localhost:8080
#
# ğŸ“Š æœåŠ¡ç«¯å£ï¼š
#   - MySQL: 3306
#   - PostgreSQL: 5432  
#   - Redis: 6379
#   - RBACæœåŠ¡å™¨: 8080
#
# ğŸ’¾ æ•°æ®æŒä¹…åŒ–ï¼š
#   - MySQLæ•°æ®ï¼š./mysql_data
#   - PostgreSQLæ•°æ®ï¼š./postgres_data
#   - Redisæ•°æ®ï¼š./redis_data
# =================================================================================

version: '3.8'

services:
  # MySQLæ•°æ®åº“
  mysql:
    image: mysql:8.0
    container_name: rbac_mysql
    environment:
      MYSQL_ROOT_PASSWORD: rootpassword
      MYSQL_DATABASE: rbac_admin
      MYSQL_USER: rbac_user
      MYSQL_PASSWORD: rbac_password
    ports:
      - "3306:3306"
    volumes:
      - mysql_data:/var/lib/mysql
      - ./init/mysql:/docker-entrypoint-initdb.d
    networks:
      - rbac_network

  # PostgreSQLæ•°æ®åº“
  postgres:
    image: postgres:15
    container_name: rbac_postgres
    environment:
      POSTGRES_DB: rbac_admin
      POSTGRES_USER: postgres
      POSTGRES_PASSWORD: postgres
    ports:
      - "5432:5432"
    volumes:
      - postgres_data:/var/lib/postgresql/data
      - ./init/postgres:/docker-entrypoint-initdb.d
    networks:
      - rbac_network

  # Redisç¼“å­˜
  redis:
    image: redis:7-alpine
    container_name: rbac_redis
    ports:
      - "6379:6379"
    volumes:
      - redis_data:/data
    networks:
      - rbac_network

  # RBACç®¡ç†å‘˜æœåŠ¡å™¨
  rbac_server:
    build: .
    container_name: rbac_admin_server
    depends_on:
      - mysql
      - postgres
      - redis
    environment:
      # æ•°æ®åº“é…ç½®ï¼ˆé€‰æ‹©ä¸€ç§ï¼‰
      # MySQLé…ç½®
      DB_TYPE: mysql
      DB_HOST: mysql
      DB_PORT: 3306
      DB_USERNAME: rbac_user
      DB_PASSWORD: rbac_password
      DB_NAME: rbac_admin
      
      # PostgreSQLé…ç½®ï¼ˆå¯é€‰ï¼‰
      # DB_TYPE: postgres
      # DB_HOST: postgres
      # DB_PORT: 5432
      # DB_USERNAME: postgres
      # DB_PASSWORD: postgres
      # DB_NAME: rbac_admin
      
      # Redisé…ç½®
      REDIS_HOST: redis
      REDIS_PORT: 6379
      REDIS_PASSWORD: ""
      
      # æœåŠ¡å™¨é…ç½®
      SERVER_PORT: 8080
      SERVER_HOST: 0.0.0.0
      
      # JWTé…ç½®
      JWT_SECRET: your_jwt_secret_key_here
      JWT_EXPIRE: 7200
      
      # æ—¥å¿—é…ç½®
      LOG_LEVEL: info
      LOG_FORMAT: json
      LOG_OUTPUT: stdout
    ports:
      - "8080:8080"
    volumes:
      - ./logs:/app/logs
      - ./uploads:/app/uploads
    networks:
      - rbac_network
    restart: unless-stopped

volumes:
  mysql_data:
  postgres_data:
  redis_data:

networks:
  rbac_network:
    driver: bridge